#!/usr/bin/env zsh
set -euo pipefail

cd "$(dirname "$0")"

pid=""

snapshot() {
	{
		stat -f "%m %N" Package.swift
		find sources -type f \( -name "*.swift" -o -name "*.plist" \) -print0 | xargs -0 stat -f "%m %N"
	} | shasum | awk '{print $1}'
}

stop() {
	if [[ -n "$pid" ]] && kill -0 "$pid" 2>/dev/null; then
		kill "$pid" 2>/dev/null || true
		wait "$pid" 2>/dev/null || true
	fi
	pid=""
}

start() {
	stop
	swift build
	./.build/debug/section &
	pid=$!
}

trap 'stop; exit 0' INT TERM EXIT

hash="$(snapshot)"
start

while true; do
	sleep 0.4
	next="$(snapshot)"
	if [[ "$next" != "$hash" ]]; then
		hash="$next"
		start
	fi
done
