#!/usr/bin/env zsh
set -euo pipefail

root="$(cd "$(dirname "$0")/.." && pwd)"
out="$root/dist"
work="$(mktemp -d)"
trap 'rm -rf "$work"' EXIT

mkdir -p "$out"

cat > "$work/draw.swift" <<'SWIFT'
import AppKit

func save(_ image: NSImage, _ path: String) {
	guard let data = image.tiffRepresentation,
		let bitmap = NSBitmapImageRep(data: data),
		let png = bitmap.representation(using: .png, properties: [:])
	else { return }
	try? png.write(to: URL(fileURLWithPath: path))
}

func icon(_ path: String) {
	let size = NSSize(width: 1024, height: 1024)
	let image = NSImage(size: size)
	image.lockFocus()

	let rect = NSRect(origin: .zero, size: size)
	NSColor.black.setFill()
	NSBezierPath(roundedRect: rect, xRadius: 220, yRadius: 220).fill()
	NSColor(calibratedRed: 0.12, green: 0.12, blue: 0.12, alpha: 1).setStroke()
	let border = NSBezierPath(roundedRect: NSRect(x: 12, y: 12, width: 1000, height: 1000), xRadius: 208, yRadius: 208)
	border.lineWidth = 24
	border.stroke()

	let color = NSColor(calibratedRed: 0.95, green: 0.96, blue: 0.98, alpha: 1)
	color.setStroke()

	let back = NSBezierPath(roundedRect: NSRect(x: 200, y: 220, width: 420, height: 420), xRadius: 72, yRadius: 72)
	back.lineWidth = 58
	back.stroke()

	let front = NSBezierPath(roundedRect: NSRect(x: 390, y: 390, width: 420, height: 420), xRadius: 72, yRadius: 72)
	front.lineWidth = 58
	front.stroke()

	image.unlockFocus()
	save(image, path)
}

let args = CommandLine.arguments
icon(args[1])
SWIFT

swift "$work/draw.swift" "$work/icon.png"

mkdir -p "$work/icon.iconset"
for size in 16 32 128 256 512; do
	sips -z $size $size "$work/icon.png" --out "$work/icon.iconset/icon_${size}x${size}.png" >/dev/null
	double=$((size * 2))
	sips -z $double $double "$work/icon.png" --out "$work/icon.iconset/icon_${size}x${size}@2x.png" >/dev/null
done
iconutil -c icns "$work/icon.iconset" -o "$out/SectionIcon.icns"
